<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Maintenance Requests</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Manage Maintenance Requests</h1>

  <!-- View Maintenance Requests Button -->
  <button id="viewRequests">View Maintenance Requests</button>

  <!-- Maintenance Request List Table -->
  <h2>Maintenance Requests</h2>
  <table id="requestTable">
    <thead>
      <tr>
        <th>Property</th>
        <th>Issue</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requests"></tbody>
  </table>

  <script>
    document.getElementById("viewRequests").addEventListener("click", function (e) {
      e.preventDefault();
      loadRequests();
    });

    function loadRequests() {
      const token = localStorage.getItem("token");
      console.log(token);
      if (!token) {
        console.error("No token found. Please log in.");
        window.location.href = "/login.html";
        return;
      }

      const requestList = document.getElementById("requests");

      fetch("http://localhost:5000/maintenance/view-requests", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
      })
        .then((response) => {
          if (!response.ok) {
            console.error("HTTP erddddror:", response.statusText);
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((requests) => {
            if (requests.length === 0) {
                requestList.innerHTML = "<tr><td colspan='4'>No requests available.</td></tr>";
            } else {

                requestList.innerHTML = requests.map(request => 
                `<tr data-id="${request.PropertyID}">
                    <td>${request.PropertyID}</td>
                    <td>${request.Description}</td>
                    <td>
                        <select class="statusSelect">
                            <option value="Pending" ${request.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="In Progress" ${request.Status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Resolved" ${request.Status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                    </td>
                    <td>
                        <button class="updateButton">Update</button>
                        <button class="deleteButton">Delete</button>
                    </td>
                </tr>
                `).join("");
                attachRequestActions();
            }
        })
        .catch((error) => {
          console.error("Error loading requests:", error);
          requestList.innerHTML = "<tr><td colspan='4'>Error loading requests.</td></tr>";
        });
    }

    function attachRequestActions() {
      document.querySelectorAll("#requests tr").forEach((row) => {
        const updateBtn = row.querySelector(".updateButton");
        const deleteBtn = row.querySelector(".deleteButton");

        const id = row.dataset.id;

        updateBtn.addEventListener("click", () => {
          const status = row.querySelector(".statusSelect").value;
          updateRequest(id, status);
        });

        deleteBtn.addEventListener("click", () => {
          if (confirm("Are you sure you want to delete this request?")) {
            deleteRequest(id);
          }
        });
      });
    }

    function updateRequest(id, status) {
      const token = localStorage.getItem("token");

      fetch(`http://localhost:5000/maintenance/update/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ status }),
      })
        .then((res) => {
          if (!res.ok) {
            console.error("Failed to update request:", res.statusText);
            alert("Failed to update request");
            throw new Error("Failed to update request");
          }
          return res.json();
        })
        .then(() => {
          loadRequests(); // Reload the list after update
        })
        .catch((error) => {
          console.error("Error updating request:", error);
        });
    }

    function deleteRequest(id) {
      const token = localStorage.getItem("token");

      fetch(`http://localhost:5000/maintenance/delete/${id}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      })
        .then(() => loadRequests()) // Reload the list after deletion
        .catch((error) => console.error("Error deleting request:", error));
    }
  </script>
</body>
</html>
